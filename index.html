<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì–¼êµ´ ëª¨ìì´í¬ (ëª¨ë¸ ì„ íƒí˜•)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- face-api.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/dist/face-api.min.js"></script>
    
    <style>
        /* Inter í°íŠ¸ ì„í¬íŠ¸ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* ì»¤ìŠ¤í…€ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸ */
        #drop-zone.is-dragover {
            border-color: #3498db;
            background-color: #f7fafc;
        }
        
        /* ë°˜ì‘í˜• ìº”ë²„ìŠ¤/ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ */
        #image-container img,
        #image-container canvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        #result-canvas.drawing-mode {
            cursor: crosshair;
        }
        #result-canvas.eraser-mode {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eraser"><path d="M22 13L16 19M22 13L13 22L4 13L13 4L22 13Z"></path></svg>') 12 12, auto;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOutDown {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, 20px); }
        }
        .toast-enter {
            animation: fadeInUp 0.3s forwards;
        }
        .toast-exit {
            animation: fadeOutDown 0.3s forwards;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toast-container" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-50 hidden pointer-events-none">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium text-center whitespace-nowrap">
            <span id="toast-message">ì•Œë¦¼ ë©”ì‹œì§€</span>
        </div>
    </div>

    <!-- ìˆ˜ë™ ë³µì‚¬ ì•ˆë‚´ ëª¨ë‹¬ -->
    <div id="manual-copy-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 dark:bg-yellow-900 mb-4">
                    <svg class="h-6 w-6 text-yellow-600 dark:text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">ìë™ ë³µì‚¬ ì°¨ë‹¨ë¨</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        ë³´ì•ˆ í™˜ê²½ ì œí•œìœ¼ë¡œ ì¸í•´ ìë™ ë³µì‚¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        ì•„ë˜ ì´ë¯¸ì§€ë¥¼ <strong>ìš°í´ë¦­</strong> í›„ <strong>'ì´ë¯¸ì§€ ë³µì‚¬'</strong>ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </p>
                </div>
                <div class="mt-4 bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                    <img id="manual-copy-image" src="" alt="ë³µì‚¬ìš© ì´ë¯¸ì§€" class="w-full h-auto rounded border border-gray-300 dark:border-gray-600">
                </div>
                <div class="mt-5 sm:mt-6">
                    <button type="button" id="close-modal-button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
        <header class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-2xl font-bold text-center text-blue-600 dark:text-blue-400">AI ì–¼êµ´ ëª¨ìì´í¬</h1>
            <p class="text-center text-gray-600 dark:text-gray-400 mt-1">ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ! AI ë° ìˆ˜ë™ìœ¼ë¡œ ì–¼êµ´ì„ ëª¨ìì´í¬ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
        </header>

        <main class="p-6 md:p-8">
            <!-- 1. ëª¨ë¸ ë¡œë”© í™”ë©´ (ì´ˆê¸°) -->
            <div id="model-loading-screen" class="flex flex-col items-center justify-center min-h-[300px]">
                <div class="spinner"></div>
                <p class="mt-4 text-lg font-medium">ê¸°ë³¸ AI ëª¨ë¸ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p>
                <p class="text-gray-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <!-- 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ í™”ë©´ -->
            <div id="upload-screen" class="hidden">
                <div id="drop-zone" class="border-4 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 md:p-12 text-center cursor-pointer transition-colors duration-300 hover:border-blue-500 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <!-- ì˜ˆì‹œ ì•„ì´ì½˜ -->
                    <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p class="mt-4 text-lg font-semibold">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”</p>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">ë˜ëŠ”</p>
                    <button id="upload-button" type="button" class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        íŒŒì¼ ì„ íƒ
                    </button>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">JPG, PNG íŒŒì¼ / Ctrl+V ë¡œ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
                </div>
                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
                <input type="file" id="file-input" class="hidden" accept="image/png, image/jpeg">
            </div>

            <!-- 3. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì‹¤í–‰ í™”ë©´ -->
            <div id="preview-screen" class="hidden">
                <div id="image-container" class="relative w-full mb-4">
                    <img id="preview-image" src="" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" class="w-full h-auto rounded-lg shadow-lg" />
                    <!-- ì²˜ë¦¬ ì¤‘ ìŠ¤í”¼ë„ˆ ì˜¤ë²„ë ˆì´ -->
                    <div id="processing-spinner" class="hidden absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center rounded-lg z-10">
                        <div class="spinner"></div>
                        <p id="processing-message" class="text-white text-lg font-medium mt-4">ë¶„ì„ ì¤‘...</p>
                    </div>
                </div>
                
                <!-- AI ëª¨ë¸ ì„ íƒ ë° ë¯¼ê°ë„ ì„¤ì • -->
                <div class="mb-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                    
                    <!-- ëª¨ë¸ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼ -->
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">AI ëª¨ë¸ ì„ íƒ:</p>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer p-2 border border-blue-200 rounded-lg bg-white dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-gray-600 flex-1">
                                <input type="radio" name="ai-model" value="tiny" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500" checked>
                                <div class="ml-2 text-sm">
                                    <span class="block font-medium text-gray-900 dark:text-gray-100">âš¡ í‘œì¤€ ëª¨ë¸</span>
                                    <span class="block text-xs text-gray-500 dark:text-gray-400">ë¹ ë¦„, ì •ë©´ ì–¼êµ´ ì¸ì‹</span>
                                </div>
                            </label>
                            <label class="flex items-center cursor-pointer p-2 border border-purple-200 rounded-lg bg-white dark:bg-gray-800 hover:bg-purple-50 dark:hover:bg-gray-600 flex-1">
                                <input type="radio" name="ai-model" value="ssd" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 focus:ring-purple-500">
                                <div class="ml-2 text-sm">
                                    <span class="block font-medium text-gray-900 dark:text-gray-100">ğŸ¢ ê³ ì„±ëŠ¥ ëª¨ë¸</span>
                                    <span class="block text-xs text-gray-500 dark:text-gray-400">ëŠë¦¼, ì˜†ëª¨ìŠµ/ì‘ì€ ì–¼êµ´</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- ë¯¼ê°ë„ ìŠ¬ë¼ì´ë” -->
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex-grow">
                            <div class="flex justify-between mb-1">
                                <label for="score-threshold" class="text-sm font-semibold text-gray-700 dark:text-gray-200">AI ì¸ì‹ ë¯¼ê°ë„</label>
                                <span id="score-threshold-value" class="text-sm font-bold text-blue-600 dark:text-blue-300">ì¤‘ê°„ (0.5)</span>
                            </div>
                            <input type="range" id="score-threshold" min="0.1" max="0.9" step="0.1" value="0.5" class="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span>ë¯¼ê°í•¨ (ë§ì´ ì¡ìŒ)</span>
                                <span>ì—„ê²©í•¨ (í™•ì‹¤í•œ ê²ƒë§Œ)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="change-image-button" type="button" class="w-full px-4 py-3 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                        ë‹¤ë¥¸ ì´ë¯¸ì§€ ì„ íƒ
                    </button>
                    <button id="run-mosaic-button" type="button" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        ëª¨ìì´í¬ ì‹¤í–‰
                    </button>
                </div>
            </div>

            <!-- 4. ê²°ê³¼ í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ í™”ë©´ -->
            <div id="result-screen" class="hidden">
                <div id="canvas-container" class="relative w-full mb-4">
                    <canvas id="result-canvas" class="w-full h-auto rounded-lg shadow-lg"></canvas>
                </div>
                
                <!-- ìˆ˜ë™ ëª¨ìì´í¬ ë„êµ¬ ì»¨íŠ¸ë¡¤ -->
                <div id="manual-mosaic-controls" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">ìˆ˜ë™ ëª¨ìì´í¬ ë„êµ¬</h3>
                        <button id="exit-manual-mode-top" type="button" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            ë‹«ê¸° âœ•
                        </button>
                    </div>
                    
                    <!-- ì»¨íŠ¸ë¡¤: ë¸ŒëŸ¬ì‹œ í¬ê¸° & í”½ì…€ í¬ê¸° -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <label for="brush-size" class="text-sm font-medium whitespace-nowrap">ë¸ŒëŸ¬ì‹œ í¬ê¸°(ì˜ì—­):</label>
                            <input type="range" id="brush-size" min="10" max="150" value="40" class="flex-grow accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            <span id="brush-size-value" class="text-sm font-medium w-8 text-right">40</span>px
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <label for="pixel-size" class="text-sm font-medium whitespace-nowrap">ëª¨ìì´í¬ ì…ì(í”½ì…€):</label>
                            <input type="range" id="pixel-size" min="5" max="50" value="15" class="flex-grow accent-pink-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            <span id="pixel-size-value" class="text-sm font-medium w-8 text-right">15</span>px
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button id="toggle-draw-mosaic" type="button" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 flex-1 flex items-center justify-center gap-2">
                            <span>âœï¸</span> ëª¨ìì´í¬ ê·¸ë¦¬ê¸°
                        </button>
                        <button id="toggle-eraser" type="button" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition-transform transform hover:scale-105 flex-1 flex items-center justify-center gap-2">
                            <span>ğŸ§¹</span> ì§€ìš°ê°œ
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ì„ ëˆ„ë¥¸ ì±„ë¡œ ì´ë¯¸ì§€ ìœ„ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
                </div>
                
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="start-new-button" type="button" class="w-full px-4 py-3 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                        ìƒˆ ì´ë¯¸ì§€ë¡œ ì‹œì‘
                    </button>
                    <button id="manual-mosaic-tool-button" type="button" class="w-full px-4 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        ìˆ˜ë™ ëª¨ìì´í¬
                    </button>
                    <button id="download-button" type="button" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button id="copy-to-clipboard-button" type="button" class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 col-span-full md:col-span-1 md:col-start-2">
                        í´ë¦½ë³´ë“œì— ë³µì‚¬
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // --- DOM ìš”ì†Œ ì°¸ì¡° ---
        const screens = {
            modelLoading: document.getElementById('model-loading-screen'),
            upload: document.getElementById('upload-screen'),
            preview: document.getElementById('preview-screen'),
            result: document.getElementById('result-screen'),
        };
        const dropZone = document.getElementById('drop-zone');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        
        const previewImage = document.getElementById('preview-image');
        const processingSpinner = document.getElementById('processing-spinner');
        const processingMessage = document.getElementById('processing-message');
        const changeImageButton = document.getElementById('change-image-button');
        const runMosaicButton = document.getElementById('run-mosaic-button');
        
        const resultCanvas = document.getElementById('result-canvas');
        const startNewButton = document.getElementById('start-new-button');
        const downloadButton = document.getElementById('download-button');
        const copyToClipboardButton = document.getElementById('copy-to-clipboard-button');
        
        // ìˆ˜ë™ ëª¨ìì´í¬ ê´€ë ¨ ìš”ì†Œ
        const manualMosaicToolButton = document.getElementById('manual-mosaic-tool-button');
        const manualMosaicControls = document.getElementById('manual-mosaic-controls');
        
        const brushSizeSlider = document.getElementById('brush-size');
        const brushSizeValueSpan = document.getElementById('brush-size-value');
        
        const pixelSizeSlider = document.getElementById('pixel-size');
        const pixelSizeValueSpan = document.getElementById('pixel-size-value');

        const toggleDrawMosaicButton = document.getElementById('toggle-draw-mosaic');
        const toggleEraserButton = document.getElementById('toggle-eraser');
        const exitManualModeTopButton = document.getElementById('exit-manual-mode-top');

        // AI ì„¤ì • ê´€ë ¨ ìš”ì†Œ
        const scoreThresholdSlider = document.getElementById('score-threshold');
        const scoreThresholdValueSpan = document.getElementById('score-threshold-value');
        const modelRadios = document.getElementsByName('ai-model');

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì†Œ
        const toastContainer = document.getElementById('toast-container');
        const toastMessage = document.getElementById('toast-message');

        // ëª¨ë‹¬ ìš”ì†Œ
        const manualCopyModal = document.getElementById('manual-copy-modal');
        const manualCopyImage = document.getElementById('manual-copy-image');
        const closeModalButton = document.getElementById('close-modal-button');

        // AI ëª¨ë¸ ê²½ë¡œ
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/model/';
        
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let originalImage = null; // ì›ë³¸ ì´ë¯¸ì§€ ê°ì²´ ì €ì¥
        let isModelLoaded = { tiny: false, ssd: false }; // ëª¨ë¸ë³„ ë¡œë”© ìƒíƒœ
        let currentModel = 'tiny'; // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ (ê¸°ë³¸ê°’ tiny)
        
        let isDrawing = false;
        let isEraserMode = false;
        let lastX = 0;
        let lastY = 0;
        
        // ë¸ŒëŸ¬ì‹œ ë° í”½ì…€ ì„¤ì •
        let brushSize = parseInt(brushSizeSlider.value);
        let pixelSize = parseInt(pixelSizeSlider.value);
        let detectionThreshold = parseFloat(scoreThresholdSlider.value); // ê¸°ë³¸ê°’ 0.5

        let currentCanvasContext = null; // í˜„ì¬ ì‘ì—… ì¤‘ì¸ ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸
        let manualDrawingLayer = null; // ìˆ˜ë™ ë“œë¡œì‰ì„ ìœ„í•œ ì„ì‹œ ìº”ë²„ìŠ¤

        // --- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜ (alert ëŒ€ì²´) ---
        let toastTimeout;
        function showToast(message, type = 'info') {
            toastMessage.textContent = message;
            toastContainer.classList.remove('hidden');
            toastContainer.classList.remove('toast-exit');
            toastContainer.classList.add('toast-enter');
            
            // ë°°ê²½ìƒ‰ ë³€ê²½ (íƒ€ì…ì— ë”°ë¼)
            const toastInner = toastContainer.firstElementChild;
            if (type === 'error') {
                toastInner.classList.remove('bg-gray-800', 'bg-green-600');
                toastInner.classList.add('bg-red-600');
            } else if (type === 'success') {
                toastInner.classList.remove('bg-gray-800', 'bg-red-600');
                toastInner.classList.add('bg-green-600');
            } else {
                toastInner.classList.remove('bg-red-600', 'bg-green-600');
                toastInner.classList.add('bg-gray-800');
            }

            if (toastTimeout) clearTimeout(toastTimeout);
            
            toastTimeout = setTimeout(() => {
                toastContainer.classList.remove('toast-enter');
                toastContainer.classList.add('toast-exit');
                setTimeout(() => {
                    toastContainer.classList.add('hidden');
                }, 300);
            }, 3000); // 3ì´ˆ í›„ ì‚¬ë¼ì§
        }

        // --- í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenId]) {
                screens[screenId].classList.remove('hidden');
            }
        }
        
        // --- ìŠ¤í”¼ë„ˆ ì œì–´ í•¨ìˆ˜ (ë©”ì‹œì§€ ì§€ì›) ---
        function showProcessingSpinner(show, message = "ì²˜ë¦¬ ì¤‘...") {
            processingMessage.textContent = message;
            if (show) {
                processingSpinner.classList.remove('hidden');
                processingSpinner.classList.add('flex');
            } else {
                processingSpinner.classList.add('hidden');
                processingSpinner.classList.remove('flex');
            }
        }

        // --- 1. AI ëª¨ë¸ ë¡œë“œ ---
        async function loadInitialModel() {
            try {
                // ê¸°ë³¸ì ìœ¼ë¡œ Tiny ëª¨ë¸ë§Œ ë¨¼ì € ë¡œë“œ (ë¹ ë¥¸ ì‹œì‘)
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                isModelLoaded.tiny = true;
                showScreen('upload'); 
                showToast("AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ (í‘œì¤€ ëª¨ë“œ)", 'success');
            } catch (error) {
                console.error("AI ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
                showToast("AI ëª¨ë¸ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.", 'error');
            }
        }

        async function loadSsdModel() {
            if (isModelLoaded.ssd) return true; // ì´ë¯¸ ë¡œë“œë¨
            
            showProcessingSpinner(true, "ê³ ì„±ëŠ¥ AI ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘... (5MB)");
            try {
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                isModelLoaded.ssd = true;
                showProcessingSpinner(false);
                showToast("ê³ ì„±ëŠ¥ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!", 'success');
                return true;
            } catch (error) {
                showProcessingSpinner(false);
                console.error("ê³ ì„±ëŠ¥ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
                showToast("ê³ ì„±ëŠ¥ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'error');
                // ì‹¤íŒ¨ ì‹œ ë¼ë””ì˜¤ ë²„íŠ¼ ì›ë³µ
                modelRadios[0].checked = true;
                currentModel = 'tiny';
                return false;
            }
        }

        // --- 2. íŒŒì¼ ì²˜ë¦¬ ---
        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showToast("ì´ë¯¸ì§€ íŒŒì¼(JPG, PNG)ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                previewImage.src = imageUrl;
                
                // ì›ë³¸ ì´ë¯¸ì§€ ê°ì²´ ìƒì„± (ë‚˜ì¤‘ì— ìº”ë²„ìŠ¤ì— ê·¸ë¦´ ë•Œ í•„ìš”)
                originalImage = new Image();
                originalImage.onload = () => {
                    showScreen('preview'); // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ ë¯¸ë¦¬ë³´ê¸° í™”ë©´ í‘œì‹œ
                    showProcessingSpinner(false);
                    resultCanvas.width = 0; // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                    resultCanvas.height = 0;
                    // ìˆ˜ë™ ëª¨ìì´í¬ ëª¨ë“œ ë¹„í™œì„±í™” ë° ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
                    exitManualMosaicMode();
                };
                originalImage.src = imageUrl;
            };
            reader.readAsDataURL(file);
        }

        // --- 3. ëª¨ìì´í¬ ì²˜ë¦¬ ì‹¤í–‰ ---
        async function runMosaic() {
            if (!originalImage) {
                showToast("ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", 'error');
                return;
            }

            // í˜„ì¬ ëª¨ë¸ì— ë”°ë¼ ë©”ì‹œì§€ ë³€ê²½
            const statusMsg = currentModel === 'ssd' 
                ? "ê³ ì„±ëŠ¥ AIê°€ ì •ë°€ ë¶„ì„ ì¤‘...\n(ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)" 
                : "í‘œì¤€ AIê°€ ë¹ ë¥´ê²Œ ë¶„ì„ ì¤‘...";
            
            showProcessingSpinner(true, statusMsg);
            runMosaicButton.disabled = true;
            runMosaicButton.textContent = "ì²˜ë¦¬ ì¤‘...";

            try {
                // ìº”ë²„ìŠ¤ ì„¤ì •
                currentCanvasContext = resultCanvas.getContext('2d');
                resultCanvas.width = originalImage.naturalWidth;
                resultCanvas.height = originalImage.naturalHeight;

                // 1. ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦½ë‹ˆë‹¤.
                currentCanvasContext.drawImage(originalImage, 0, 0);

                let detections = [];

                if (currentModel === 'ssd') {
                     // ê³ ì„±ëŠ¥ ëª¨ë¸ (SSD MobileNet V1)
                     if (!isModelLoaded.ssd) await loadSsdModel();
                     
                     const detectorOptions = new faceapi.SsdMobilenetv1Options({
                        minConfidence: detectionThreshold
                    });
                    detections = await faceapi.detectAllFaces(originalImage, detectorOptions);

                } else {
                    // í‘œì¤€ ëª¨ë¸ (Tiny Face Detector)
                    // scoreThresholdê°€ ë‚®ì„ìˆ˜ë¡ ë¯¼ê°
                    // TinyFaceDetectorOptionsì—ì„œëŠ” scoreThreshold ì‚¬ìš©
                    // ìŠ¬ë¼ì´ë” ê°’(0.1~0.9)ì„ ê·¸ëŒ€ë¡œ ì ìš©í•˜ë˜,
                    // 0.5(ì¤‘ê°„) ê¸°ì¤€. TinyëŠ” 0.5ê°€ ê¸°ë³¸.
                    const detectorOptions = new faceapi.TinyFaceDetectorOptions({
                        inputSize: 512, 
                        scoreThreshold: detectionThreshold
                    });
                    detections = await faceapi.detectAllFaces(originalImage, detectorOptions);
                }
                
                // 2. ê°ì§€ëœ ì–¼êµ´ì— ëª¨ìì´í¬ ì ìš©
                if (detections.length > 0) {
                    // ì²« ë²ˆì§¸ ì–¼êµ´ ê¸°ì¤€ìœ¼ë¡œ ëª¨ìì´í¬ ì…ì í¬ê¸° ìë™ ì„¤ì •
                    const firstFaceWidth = detections[0].box.width;
                    const autoPixelSize = Math.max(10, Math.floor(firstFaceWidth / 15));
                    
                    // UI ë° ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    pixelSize = autoPixelSize;
                    pixelSizeSlider.value = autoPixelSize;
                    pixelSizeValueSpan.textContent = autoPixelSize;
                    
                    applyPixelation(currentCanvasContext, detections);
                    showToast(`${detections.length}ê°œì˜ ì–¼êµ´ì„ ì°¾ì•„ ëª¨ìì´í¬ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    console.log("ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    showToast("ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª¨ë¸ì´ë‚˜ ë¯¼ê°ë„ë¥¼ ë³€ê²½í•´ë³´ì„¸ìš”.", 'info');
                }

                showScreen('result'); // ê²°ê³¼ í™”ë©´ í‘œì‹œ
                // ìˆ˜ë™ ëª¨ìì´í¬ ëª¨ë“œ ë¹„í™œì„±í™” ë° ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
                exitManualMosaicMode();

            } catch (error) {
                console.error("ëª¨ìì´í¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                showToast("ëª¨ìì´í¬ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'error');
            } finally {
                showProcessingSpinner(false);
                runMosaicButton.disabled = false;
                runMosaicButton.textContent = "ëª¨ìì´í¬ ì‹¤í–‰";
            }
        }
        
        // --- 4. í”½ì…€ ëª¨ìì´í¬ íš¨ê³¼ ì ìš© í•¨ìˆ˜ ---
        function applyPixelation(ctx, detections, area = null) {
            // ì„ì‹œ ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í”½ì…€í™” (ì´ ë°©ì‹ì´ ì„±ëŠ¥ì´ ìš°ìˆ˜í•¨)
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // í”½ì…€í™” ë¹„í™œì„±í™” (ì„ ëª…í•œ í”½ì…€ íš¨ê³¼)
            ctx.imageSmoothingEnabled = false;

            const targets = area ? [{ box: area }] : detections;

            targets.forEach(detection => {
                const { x, y, width, height } = detection.box;
                
                // ì–¼êµ´ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ í”½ì…€ í¬ê¸° ê²°ì • (ìµœì†Œ 10x10)
                // AI ìë™ ëª¨ìì´í¬ ì‹œ í”½ì…€ í¬ê¸° ê³„ì‚°
                const pixelFactor = Math.max(10, Math.floor(width / 15));
                
                tempCanvas.width = pixelFactor;
                tempCanvas.height = pixelFactor;

                // 1. ì–¼êµ´ ì˜ì—­ì„ ì‘ì€ ì„ì‹œ ìº”ë²„ìŠ¤ë¡œ ì¶•ì†Œí•˜ì—¬ ê·¸ë¦½ë‹ˆë‹¤. (í”½ì…€í™”)
                tempCtx.drawImage(originalImage, x, y, width, height, 0, 0, pixelFactor, pixelFactor);

                // 2. ì¶•ì†Œëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ì›ë˜ ìº”ë²„ìŠ¤ì˜ ì–¼êµ´ ìœ„ì¹˜ì— í™•ëŒ€í•˜ì—¬ ê·¸ë¦½ë‹ˆë‹¤.
                ctx.drawImage(tempCanvas, 0, 0, pixelFactor, pixelFactor, x, y, width, height);
            });
        }

        // --- 5. ì•± ì´ˆê¸°í™” ë° ë‹¤ìš´ë¡œë“œ ---
        function resetApp() {
            originalImage = null;
            previewImage.src = "";
            fileInput.value = null; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            resultCanvas.width = 0; // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            resultCanvas.height = 0;
            exitManualMosaicMode(); // ìˆ˜ë™ ëª¨ìì´í¬ ëª¨ë“œ ë¹„í™œì„±í™”
            showScreen('upload');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'ai_mosaic_image.png';
            link.href = resultCanvas.toDataURL('image/png');
            link.click();
        }

        // --- í´ë¦½ë³´ë“œ ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „) ---
        async function copyImageToClipboard() {
            try {
                const blob = await new Promise(resolve => resultCanvas.toBlob(resolve, 'image/png'));
                if (!blob) {
                     showToast("ë³µì‚¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", 'error');
                     return;
                }
                const item = new ClipboardItem({ "image/png": blob });
                await navigator.clipboard.write([item]);
                showToast("ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');
            } catch (error) {
                console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", error);
                // ë³´ì•ˆ ì •ì±… ìœ„ë°˜(ìƒŒë“œë°•ìŠ¤ iframe)ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
                if (error.name === 'NotAllowedError' || error.name === 'SecurityError') {
                    showManualCopyModal();
                } else {
                    showToast("í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (HTTPS í™˜ê²½ í•„ìˆ˜)", 'error');
                }
            }
        }
        
        // ìˆ˜ë™ ë³µì‚¬ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showManualCopyModal() {
            manualCopyImage.src = resultCanvas.toDataURL('image/png');
            manualCopyModal.classList.remove('hidden');
        }

        async function pasteImageFromClipboard(event) {
            if (event.clipboardData && event.clipboardData.files.length > 0) {
                handleFile(event.clipboardData.files[0]);
                event.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ë°©ì§€
            } else if (event.clipboardData && event.clipboardData.items) {
                for (let i = 0; i < event.clipboardData.items.length; i++) {
                    const item = event.clipboardData.items[i];
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            handleFile(file);
                            event.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ë°©ì§€
                            return;
                        }
                    }
                }
            }
        }


        // --- ìˆ˜ë™ ëª¨ìì´í¬ ë„êµ¬ ê¸°ëŠ¥ ---

        function enterManualMosaicMode() {
            if (!currentCanvasContext || !originalImage) {
                showToast("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ëª¨ìì´í¬ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.", 'error');
                return;
            }

            manualMosaicControls.classList.remove('hidden');
            manualMosaicToolButton.classList.add('hidden'); // ìˆ˜ë™ ëª¨ìì´í¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸°

            // ìˆ˜ë™ ë“œë¡œì‰ì„ ìœ„í•œ ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„±
            manualDrawingLayer = document.createElement('canvas');
            manualDrawingLayer.width = resultCanvas.width;
            manualDrawingLayer.height = resultCanvas.height;
            const manualCtx = manualDrawingLayer.getContext('2d');

            // ì›ë³¸ ìº”ë²„ìŠ¤ì˜ ë‚´ìš©ì„ ì„ì‹œ ìº”ë²„ìŠ¤ë¡œ ë³µì‚¬ (ì´ˆê¸° ìƒíƒœ)
            manualCtx.drawImage(resultCanvas, 0, 0);

            // resultCanvasì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            resultCanvas.addEventListener('mousedown', startDrawing);
            resultCanvas.addEventListener('mousemove', draw);
            resultCanvas.addEventListener('mouseup', stopDrawing);
            resultCanvas.addEventListener('mouseout', stopDrawing);

            // UI ì´ˆê¸°í™”: ìŠ¬ë¼ì´ë” ê°’ ë™ê¸°í™”
            brushSizeValueSpan.textContent = brushSizeSlider.value;
            pixelSizeValueSpan.textContent = pixelSizeSlider.value;

            // ì¤‘ìš”: ëª¨ìì´í¬ ê·¸ë¦¬ê¸° ëª¨ë“œ ê¸°ë³¸ í™œì„±í™”
            toggleDrawMosaic();
        }

        function exitManualMosaicMode() {
            manualMosaicControls.classList.add('hidden');
            manualMosaicToolButton.classList.remove('hidden'); // ìˆ˜ë™ ëª¨ìì´í¬ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
            
            resultCanvas.removeEventListener('mousedown', startDrawing);
            resultCanvas.removeEventListener('mousemove', draw);
            resultCanvas.removeEventListener('mouseup', stopDrawing);
            resultCanvas.removeEventListener('mouseout', stopDrawing);
            
            resultCanvas.classList.remove('drawing-mode', 'eraser-mode');
            isDrawing = false;
            isEraserMode = false;

            // ë²„íŠ¼ ìƒ‰ìƒ ì´ˆê¸°í™”
            toggleDrawMosaicButton.classList.remove('bg-purple-800', 'ring-2', 'ring-purple-400');
            toggleEraserButton.classList.remove('bg-red-800', 'ring-2', 'ring-red-300');
        }

        function getCanvasMousePosition(event) {
            const rect = resultCanvas.getBoundingClientRect();
            const scaleX = resultCanvas.width / rect.width;
            const scaleY = resultCanvas.height / rect.height;
            return {
                x: (event.clientX - rect.left) * scaleX,
                y: (event.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            if (e.button !== 0) return; // ì¢Œí´ë¦­ë§Œ í—ˆìš©
            isDrawing = true;
            const { x, y } = getCanvasMousePosition(e);
            lastX = x;
            lastY = y;
            if (isEraserMode) {
                erase(x, y);
            } else {
                drawMosaicManual(x, y);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            const { x, y } = getCanvasMousePosition(e);
            if (isEraserMode) {
                erase(x, y);
            } else {
                drawMosaicManual(x, y);
            }
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // ìˆ˜ë™ ëª¨ìì´í¬ ê·¸ë¦¬ê¸°
        function drawMosaicManual(x, y) {
            const tempCtx = manualDrawingLayer.getContext('2d');
            
            // ìº”ë²„ìŠ¤ ë³µì› (ì´ì „ ëª¨ìì´í¬ ìœ„ì— ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šë„ë¡)
            tempCtx.clearRect(0, 0, manualDrawingLayer.width, manualDrawingLayer.height);
            tempCtx.drawImage(originalImage, 0, 0); // ì›ë³¸ ì´ë¯¸ì§€ ìœ„ì— ê·¸ë¦´ ì¤€ë¹„

            // ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œ í•´ë‹¹ ì˜ì—­ì˜ í”½ì…€ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í”½ì…€í™”
            const mosaicSize = brushSize; // ë¸ŒëŸ¬ì‹œ í¬ê¸° (ì˜ì—­)
            const halfMosaic = mosaicSize / 2;

            const startX = Math.max(0, x - halfMosaic);
            const startY = Math.max(0, y - halfMosaic);
            const endX = Math.min(originalImage.naturalWidth, x + halfMosaic);
            const endY = Math.min(originalImage.naturalHeight, y + halfMosaic);

            const width = endX - startX;
            const height = endY - startY;

            if (width <= 0 || height <= 0) return;

            // ì‘ì€ ì„ì‹œ ìº”ë²„ìŠ¤ì— ì›ë³¸ ì´ë¯¸ì§€ì˜ í•´ë‹¹ ì˜ì—­ ê·¸ë¦¬ê¸°
            const pixelCanvas = document.createElement('canvas');
            const pixelCtx = pixelCanvas.getContext('2d');
            
            // í”½ì…€ í¬ê¸°(ì…ì êµµê¸°)ëŠ” ì‚¬ìš©ìê°€ ì„¤ì •í•œ ê°’(pixelSize)ì„ ë”°ë¦…ë‹ˆë‹¤.
            const effectivePixelFactor = pixelSize; 
            
            // 1. í”½ì…€í™”ë¥¼ ìœ„í•´ ì´ë¯¸ì§€ë¥¼ ì—„ì²­ ì‘ê²Œ ì¶•ì†Œí•©ë‹ˆë‹¤.
            const scaledWidth = Math.max(1, Math.floor(width / effectivePixelFactor));
            const scaledHeight = Math.max(1, Math.floor(height / effectivePixelFactor));
            
            pixelCanvas.width = scaledWidth;
            pixelCanvas.height = scaledHeight;

            pixelCtx.imageSmoothingEnabled = false;
            // ì‘ê²Œ ê·¸ë¦¼
            pixelCtx.drawImage(originalImage, startX, startY, width, height, 0, 0, scaledWidth, scaledHeight);

            currentCanvasContext.imageSmoothingEnabled = false;
            // ë‹¤ì‹œ í¬ê²Œ ê·¸ë¦¼ (í”½ì…€í™” íš¨ê³¼)
            currentCanvasContext.drawImage(pixelCanvas, 0, 0, scaledWidth, scaledHeight, startX, startY, width, height);
        }
        
        // ì§€ìš°ê°œ
        function erase(x, y) {
            const halfBrush = brushSize / 2;
            const startX = Math.max(0, x - halfBrush);
            const startY = Math.max(0, y - halfBrush);
            const endX = Math.min(originalImage.naturalWidth, x + halfBrush);
            const endY = Math.min(originalImage.naturalHeight, y + halfBrush);

            const width = endX - startX;
            const height = endY - startY;

            if (width <= 0 || height <= 0) return;

            // ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ í•´ë‹¹ ì˜ì—­ì„ ë‹¤ì‹œ ê·¸ë ¤ì„œ ëª¨ìì´í¬ë¥¼ ì§€ì›ë‹ˆë‹¤.
            currentCanvasContext.drawImage(originalImage, startX, startY, width, height, startX, startY, width, height);
        }

        function toggleDrawMosaic() {
            isEraserMode = false;
            resultCanvas.classList.add('drawing-mode');
            resultCanvas.classList.remove('eraser-mode');
            toggleDrawMosaicButton.classList.add('bg-purple-800', 'ring-2', 'ring-purple-400');
            toggleEraserButton.classList.remove('bg-red-800', 'ring-2', 'ring-red-300');
        }

        function toggleEraser() {
            isEraserMode = true;
            resultCanvas.classList.add('eraser-mode');
            resultCanvas.classList.remove('drawing-mode');
            toggleEraserButton.classList.add('bg-red-800', 'ring-2', 'ring-red-300');
            toggleDrawMosaicButton.classList.remove('bg-purple-800', 'ring-2', 'ring-purple-400');
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); // ê¸°ë³¸ ì´ë²¤íŠ¸ ë°©ì§€
            dropZone.classList.add('is-dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('is-dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); // ê¸°ë³¸ ì´ë²¤íŠ¸ ë°©ì§€
            dropZone.classList.remove('is-dragover');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° (Ctrl+V)
        document.addEventListener('paste', (e) => {
            // ì—…ë¡œë“œ í™”ë©´ì¼ ë•Œë§Œ ë¶™ì—¬ë„£ê¸° í—ˆìš©
            if (!screens.upload.classList.contains('hidden')) {
                pasteImageFromClipboard(e);
            }
        });

        // ëª¨ìì´í¬ ì‹¤í–‰
        runMosaicButton.addEventListener('click', runMosaic);

        // ìˆ˜ë™ ëª¨ìì´í¬ ë„êµ¬ í™œì„±í™”
        manualMosaicToolButton.addEventListener('click', enterManualMosaicMode);
        
        // ìˆ˜ë™ ëª¨ìì´í¬ ì»¨íŠ¸ë¡¤ ë²„íŠ¼
        toggleDrawMosaicButton.addEventListener('click', toggleDrawMosaic);
        toggleEraserButton.addEventListener('click', toggleEraser);
        exitManualModeTopButton.addEventListener('click', exitManualMosaicMode);

        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            brushSizeValueSpan.textContent = brushSize;
        });
        
        pixelSizeSlider.addEventListener('input', (e) => {
            pixelSize = parseInt(e.target.value);
            pixelSizeValueSpan.textContent = pixelSize;
        });

        // AI ì„¤ì • ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        scoreThresholdSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            detectionThreshold = val;
            
            let label = "ì¤‘ê°„ (0.5)";
            if(val < 0.3) label = "ë§¤ìš° ë¯¼ê° (0.1~0.2)";
            else if(val < 0.5) label = "ë¯¼ê° (0.3~0.4)";
            else if(val > 0.7) label = "ë§¤ìš° ì—„ê²© (0.8~0.9)";
            else if(val > 0.5) label = "ì—„ê²© (0.6~0.7)";
            
            scoreThresholdValueSpan.textContent = `${label}`;
        });
        
        // ëª¨ë¸ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
        Array.from(modelRadios).forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const selectedValue = e.target.value;
                if (selectedValue === 'ssd' && !isModelLoaded.ssd) {
                    await loadSsdModel(); // ì„ íƒ ì‹œ ë¡œë“œ
                }
                currentModel = selectedValue;
            });
        });
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeModalButton.addEventListener('click', () => {
            manualCopyModal.classList.add('hidden');
        });

        // ë‹¤ë¥¸ ì´ë¯¸ì§€ ì„ íƒ / ìƒˆ ì´ë¯¸ì§€ë¡œ ì‹œì‘
        changeImageButton.addEventListener('click', resetApp);
        startNewButton.addEventListener('click', resetApp);
        
        // ë‹¤ìš´ë¡œë“œ
        downloadButton.addEventListener('click', downloadImage);

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        copyToClipboardButton.addEventListener('click', copyImageToClipboard);

        // --- ì•± ì‹œì‘ ---
        window.onload = () => {
            showScreen('modelLoading'); // ì•± ì‹œì‘ ì‹œ ëª¨ë¸ ë¡œë”© í™”ë©´ í‘œì‹œ
            loadInitialModel(); // ì´ˆê¸° ëª¨ë¸ ë¡œë“œ (tinyë§Œ)
        };

    </script>
</body>
</html>
